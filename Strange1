#!/usr/bin/env python3
"""
Luna HSM User Management (REST)
"""
try:
    import requests
except ImportError:
    import subprocess, sys
    subprocess.check_call([sys.executable, "-m", "pip", "install", "requests"])
    import requests

import argparse, json, os, getpass, secrets, string, re, datetime, sys

RES_DIR = "resources"
HSM_FILE = f"{RES_DIR}/hsm_mapping.json"
VERSION_MAP_FILE = f"{RES_DIR}/version_map.json"
ROLE_MAP_FILE = f"{RES_DIR}/rest_role_actions.json"
PW_STORE = f"{RES_DIR}/user_passwords.json"
os.makedirs(RES_DIR, exist_ok=True)

def load_json(path):
    if not os.path.exists(path):
        raise SystemExit(f"[ERROR] Missing: {path}")
    with open(path, "r") as f:
        return json.load(f)

def gen_pw(n=16):
    a = string.ascii_letters + string.digits + "._-"
    return ''.join(secrets.choice(a) for _ in range(n))

def save_pw(user, pw):
    data = {}
    if os.path.exists(PW_STORE):
        try: data = json.load(open(PW_STORE))
        except: data = {}
    data[user] = {"password": pw, "created_at": datetime.datetime.utcnow().isoformat()+"Z"}
    tmp = PW_STORE + ".tmp"
    with open(tmp, "w") as f: json.dump(data, f, indent=2)
    os.replace(tmp, PW_STORE)
    try: os.chmod(PW_STORE, 0o600)
    except: pass

def pick_ct(version, vmap):
    v = version.strip()
    if v in vmap:
        return f"application/vnd.safenetinc.lunasa+json;version={vmap[v]}"
    m = re.match(r"(\d+\.\d+)", v)
    if m:
        mm = m.group(1)
        if mm+".0" in vmap:
            return f"application/vnd.safenetinc.lunasa+json;version={vmap[mm+'.0']}"
        if mm in vmap:
            return f"application/vnd.safenetinc.lunasa+json;version={vmap[mm]}"
    raise SystemExit(f"[ERROR] No CT mapping for {v}")

def rest_login(sess, base, user, pw):
    r = sess.post(f"{base}/auth/session", auth=(user, pw), timeout=20)
    if r.status_code not in (200,204):
        raise SystemExit(f"[ERROR] Login failed: {r.status_code} {r.text}")

    cookies = sess.cookies.get_dict()
    for k, v in cookies.items():
        sess.headers.update({"Cookie": f"{k}={v}"})

    print("[INFO] Login ok.")

def detect_fw(sess, base):
    r = sess.get(f"{base}/api/lunasa", timeout=20)
    r.raise_for_status()
    v = r.json().get("version","").strip()
    if not v:
        raise SystemExit("[ERROR] No firmware version.")
    print(f"[INFO] Firmware: {v}")
    return v

def create_role(sess, base, rid, name):
    r = sess.post(f"{base}/api/lunasa/roles",
                  json={"roleId": rid, "fullName": name}, timeout=20)
    if r.status_code not in (200,201,204):
        r.raise_for_status()
    print(f"[INFO] Role {rid} ok.")

def get_hsm_id(sess, base):
    r = sess.get(f"{base}/api/lunasa/hsms", timeout=20)
    r.raise_for_status()
    arr = r.json().get("hsms",[])
    if not arr:
        raise SystemExit("[ERROR] No HSMs.")
    h = arr[0]
    hid = h.get("serialNumber") or h.get("id") or h.get("serial")
    if not hid:
        raise SystemExit("[ERROR] No HSM id.")
    print(f"[INFO] HSM ID: {hid}")
    return hid

def attach_action(sess, base, hid, rid, act):
    return sess.post(f"{base}/api/lunasa/hsms/{hid}/roles/{rid}/actions/{act}", timeout=20)

def create_user(sess, base, uid, pw, role):
    return sess.post(f"{base}/api/lunasa/users",
                     json={"userId": uid, "password": pw, "role": role},
                     timeout=20)

def main():
    p = argparse.ArgumentParser()
    p.add_argument("--hsm-id", required=True)
    p.add_argument("--env", required=True, choices=["DEV","TE1","TE2","PROD"], type=str.upper)
    p.add_argument("--apiuser", default="admin")
    p.add_argument("--apipw")
    p.add_argument("--newuser")
    p.add_argument("--role-id", default="user_mgmt_role")
    p.add_argument("--role-name", default="User Management Role")
    a = p.parse_args()

    hmap = load_json(HSM_FILE)
    vmap = load_json(VERSION_MAP_FILE)
    amap = load_json(ROLE_MAP_FILE)

    entry = next((h for h in hmap["hsms"] if h["id"] == a.hsm_id), None)
    if not entry:
        raise SystemExit("[ERROR] HSM not found.")

    host = entry.get("ipAddress") or entry.get("host")
    port = int(entry.get("port", 8443))
    base = f"https://{host}:{port}"

    ENV_MAP = {
        "DEV":  "svc_at48994_usrmgt",
        "TE1":  "svc_at48993_usrmgt",
        "TE2":  "svc_at48992_usrmgt",
        "PROD": "svc_at49008_usrmgt"
    }
    new_user = a.newuser or ENV_MAP[a.env]

    admin_pw = a.apipw or getpass.getpass(f"Password for {a.apiuser}@HSM: ")

    new_user_pw = gen_pw()

    sess = requests.Session()
    sess.verify = False

    # ‚≠ê LOGIN MUST USE VERSION 10 CONTENT-TYPE
    sess.headers.clear()
    sess.headers.update({
        "Content-Type": "application/vnd.safenetinc.lunasa+json;version=10"
    })

    print(f"[INFO] Connecting to {host}:{port} ...")
    rest_login(sess, base, a.apiuser, admin_pw)

    # now detect real firmware
    fw = detect_fw(sess, base)

    # update CT to real firmware version
    real_ct = pick_ct(fw, vmap)
    sess.headers.update({"Content-Type": real_ct})
    print(f"[INFO] CT: {real_ct}")

    if fw not in amap:
        raise SystemExit("[ERROR] Firmware action map missing.")

    actions = amap[fw]
    print(f"[INFO] Actions: {actions}")

    create_role(sess, base, a.role_id, a.role_name)

    hid = get_hsm_id(sess, base)
    for act in actions:
        r = attach_action(sess, base, hid, a.role_id, act)
        if r.status_code in (200,201,204):
            print(f"[OK] action {act}")
        else:
            print(f"[WARN] action {act} failed ({r.status_code})")

    r = create_user(sess, base, new_user, new_user_pw, a.role_id)
    if r.status_code in (200,201,204):
        print(f"[OK] User {new_user} created")
        save_pw(new_user, new_user_pw)
    else:
        print(f"[ERROR] User failed: {r.status_code} {r.text}")
        sys.exit(1)

    print("\n[COMPLETE]\n")

if __name__ == "__main__":
    main()

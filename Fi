#!/usr/bin/env python3

# ===== Dependency Handling (LunaShell-style) =====
try:
    import requests
    import urllib3
except ImportError:
    import subprocess, sys
    print("[INFO] Installing missing dependencies: requests, urllib3")
    subprocess.check_call([sys.executable, "-m", "pip", "install", "requests", "urllib3"])
    import requests
    import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

import argparse
import os
import json
import getpass
import secrets
import string
import datetime


# ================= PATHS =================
RES_DIR = "resources"
HSM_FILE = os.path.join(RES_DIR, "hsm_mapping.json")
VERSION_MAP_FILE = os.path.join(RES_DIR, "version_map.json")
PW_STORE = os.path.join(RES_DIR, "user_passwords.json")
ROLE_RES_FILE = os.path.join(RES_DIR, "usermg_role_resources")

FIXED_ROLE_NAME = "usermanagementrole"

ENV_USER_MAP = {
    "DEV": "svc_at48994_usrmgt",
    "TE1": "svc_at48993_usrmgt",
    "TE2": "svc_at48992_usrmgt",
    "PROD": "svc_at49008_usrmgt"
}

os.makedirs(RES_DIR, exist_ok=True)


# ================= UTIL FUNCTIONS =================

def load_hsm(hsm_id):
    with open(HSM_FILE, "r") as f:
        data = json.load(f)

    for h in data.get("hsms", []):
        if h.get("id") == hsm_id:
            return h

    raise SystemExit(f"[ERROR] HSM {hsm_id} not found")


def map_version_from_fw(hsm_data):
    fw = hsm_data.get("fwVersion")

    if not fw:
        print("[WARN] fwVersion missing, defaulting to 10")
        return "10"

    if not os.path.exists(VERSION_MAP_FILE):
        print("[WARN] version_map.json missing, defaulting to 10")
        return "10"

    with open(VERSION_MAP_FILE, "r") as f:
        version_map = json.load(f)

    api_version = version_map.get(fw)

    if not api_version:
        print(f"[WARN] No mapping for fw {fw}, defaulting to 10")
        return "10"

    print(f"[INFO] Firmware {fw} mapped to API version {api_version}")
    return api_version


def luna_headers(version, octet=False):
    if octet:
        return {
            "Content-Type": f"application/vnd.safenetinc.lunasa+octet-stream;version={version}",
            "Accept": "*/*",
            "User-Agent": "curl/8.12.1"
        }
    return {
        "Content-Type": f"application/vnd.safenetinc.lunasa+json;version={version}",
        "Accept": "*/*",
        "User-Agent": "curl/8.12.1"
    }


def generate_password(length=16):
    chars = string.ascii_letters + string.digits + "._-"
    return ''.join(secrets.choice(chars) for _ in range(length))


def save_password(username, password):
    data = {}
    if os.path.exists(PW_STORE):
        with open(PW_STORE, "r") as f:
            try:
                data = json.load(f)
            except:
                data = {}

    data[username] = {
        "password": password,
        "created_at": datetime.datetime.utcnow().isoformat() + "Z"
    }

    with open(PW_STORE, "w") as f:
        json.dump(data, f, indent=2)


# ================= LUNA CALLS =================

def create_session(base_url, session, user, password, version):
    r = session.post(
        base_url + "/auth/session",
        headers=luna_headers(version),
        auth=(user, password),
        verify=False
    )

    print(f"[DEBUG] Session status: {r.status_code}")
    if r.status_code != 204:
        print("[DEBUG] Response:", r.text)

    return r.status_code == 204


def create_role(base_url, session, version):
    payload = {
        "roleId": FIXED_ROLE_NAME,
        "fullName": FIXED_ROLE_NAME
    }

    session.post(
        base_url + "/roles",
        headers=luna_headers(version),
        json=payload,
        verify=False
    )


def upload_role_resources(base_url, session, version):
    if not os.path.exists(ROLE_RES_FILE):
        raise SystemExit(f"[ERROR] Missing role resource file: {ROLE_RES_FILE}")

    with open(ROLE_RES_FILE, "rb") as f:
        raw = f.read()

    session.put(
        f"{base_url}/roles/{FIXED_ROLE_NAME}/resources",
        headers=luna_headers(version, octet=True),
        data=raw,
        verify=False
    )


def create_user(base_url, session, version, username):
    password = generate_password()

    payload = {
        "userId": username,
        "password": password
    }

    r = session.post(
        base_url + "/api/lunasa/users",
        headers=luna_headers(version),
        json=payload,
        verify=False
    )

    if r.status_code not in (200, 201, 204):
        raise SystemExit("[ERROR] User creation failed")

    save_password(username, password)
    return password


def assign_role(base_url, session, version, username):
    payload = {"roleId": FIXED_ROLE_NAME}

    session.post(
        f"{base_url}/api/lunasa/users/{username}/roles",
        headers=luna_headers(version),
        json=payload,
        verify=False
    )


# ================= MAIN =================

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--hsm-id", required=True)
    parser.add_argument("--env", required=True, choices=["DEV", "TE1", "TE2", "PROD"], type=str.upper)
    parser.add_argument("--apiuser", required=True)
    parser.add_argument("--apipass")
    parser.add_argument("--newuser")

    args = parser.parse_args()

    hsm = load_hsm(args.hsm_id)
    host = hsm.get("ipAddress") or hsm.get("host")
    base_url = f"https://{host}:8443"

    target_user = args.newuser or ENV_USER_MAP.get(args.env)
    if not target_user:
        raise SystemExit("[ERROR] Invalid environment mapping")

    api_password = args.apipass or getpass.getpass(f"Password for {args.apiuser}@HSM: ")

    print(f"[INFO] HSM ID: {args.hsm_id}")
    print(f"[INFO] Environment: {args.env}")
    print(f"[INFO] Creating user: {target_user}")

    version = map_version_from_fw(hsm)

    session = requests.Session()

    if not create_session(base_url, session, args.apiuser, api_password, version):
        raise SystemExit("[ERROR] Failed to establish Luna session")

    create_role(base_url, session, version)
    upload_role_resources(base_url, session, version)
    create_user(base_url, session, version, target_user)
    assign_role(base_url, session, version, target_user)

    print("[SUCCESS] User created and role assigned successfully.")


if __name__ == "__main__":
    main()

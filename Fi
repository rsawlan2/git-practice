#!/usr/bin/env python3
import shutil, sys, subprocess, argparse, json, os, getpass

def check_dependency(cmd):
    if shutil.which(cmd) is None:
        print(f"[ERROR] Required dependency '{cmd}' not found.")
        sys.exit(1)

check_dependency("curl")

RES_DIR = "resources"
HSM_FILE = os.path.join(RES_DIR, "hsm_mapping.json")
VERSION_FILE = os.path.join(RES_DIR, "version_map.json")
ROLE_RES_FILE = os.path.join(RES_DIR, "usermg_role_resources")
COOKIE_FILE = "luna_cookie.txt"

ROLE_NAME = "usermanagementrole"

def load_json(path):
    with open(path, "r") as f:
        return json.load(f)

def get_hsm_data(hsm_id):
    data = load_json(HSM_FILE)
    for h in data["hsms"]:
        if h["id"] == hsm_id:
            return h
    raise SystemExit(f"[ERROR] HSM {hsm_id} not found")

def map_version(hsm):
    fw = hsm["fwVersion"]
    mapping = load_json(VERSION_FILE)
    api_ver = mapping.get(fw, "10")
    print(f"[INFO] Firmware {fw} mapped to API version {api_ver}")
    return api_ver

def run(cmd):
    print(f"[DEBUG] {cmd}")
    subprocess.run(cmd, shell=True)

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--hsm-id", required=True)
    parser.add_argument("--env", required=True)
    parser.add_argument("--apiuser", required=True)
    parser.add_argument("--apipass")
    args = parser.parse_args()

    hsm = get_hsm_data(args.hsm_id)
    ip = hsm["ipAddress"]
    version = map_version(hsm)
    password = args.apipass or getpass.getpass("API Password: ")

    print(f"[INFO] HSM ID: {args.hsm_id}")

    # 1. LOGIN (creates cookie file)
    login_cmd = (
        f'curl -k -c {COOKIE_FILE} -u {args.apiuser}:{password} '
        f'-H "Content-Type: application/vnd.safenetinc.lunasa+json;version={version}" '
        f'https://{ip}:8443/auth/session'
    )
    run(login_cmd)

    # 2. CREATE ROLE
    create_role_cmd = (
        f'curl -k -b {COOKIE_FILE} -X POST '
        f'-H "Content-Type: application/vnd.safenetinc.lunasa+json;version={version}" '
        f'-d \'{{"roleId":"{ROLE_NAME}","fullName":"{ROLE_NAME}"}}\' '
        f'https://{ip}:8443/roles'
    )
    run(create_role_cmd)

    # 3. UPLOAD ROLE RESOURCES
    upload_res_cmd = (
        f'curl -k -b {COOKIE_FILE} -X PUT '
        f'-H "Content-Type: application/vnd.safenetinc.lunasa+octet-stream;version={version}" '
        f'--data-binary @{ROLE_RES_FILE} '
        f'https://{ip}:8443/roles/{ROLE_NAME}/resources'
    )
    run(upload_res_cmd)

    print("[SUCCESS] Fully executed with real curl session flow.")

if __name__ == "__main__":
    main()

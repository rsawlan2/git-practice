#!/usr/bin/env python3

# ================= Dependency Handling (LunaShell-style) =================
import shutil
import sys

def check_dependency(cmd):
    if shutil.which(cmd) is None:
        print(f"[ERROR] Required dependency '{cmd}' not found.")
        print("[INFO] Please install it before running this script.")
        sys.exit(1)

check_dependency("curl")   # curl is REQUIRED just like lunashell


# ================= Imports =================
import argparse
import subprocess
import json
import os
import getpass
import secrets
import string
import datetime


# ================= PATHS =================
RES_DIR = "resources"
HSM_FILE = os.path.join(RES_DIR, "hsm_mapping.json")
VERSION_MAP_FILE = os.path.join(RES_DIR, "version_map.json")
PW_STORE = os.path.join(RES_DIR, "user_passwords.json")
ROLE_RES_FILE = os.path.join(RES_DIR, "usermg_role_resources")

FIXED_ROLE_NAME = "usermanagementrole"

ENV_USER_MAP = {
    "DEV": "svc_at48994_usrmgt",
    "TE1": "svc_at48993_usrmgt",
    "TE2": "svc_at48992_usrmgt",
    "PROD": "svc_at49008_usrmgt"
}

os.makedirs(RES_DIR, exist_ok=True)


# ================= UTIL =================

def load_hsm(hsm_id):
    with open(HSM_FILE, "r") as f:
        data = json.load(f)

    for h in data.get("hsms", []):
        if h.get("id") == hsm_id:
            return h

    raise SystemExit(f"[ERROR] HSM {hsm_id} not found")


def map_version_from_fw(hsm_data):
    fw = hsm_data.get("fwVersion")

    if not fw:
        raise SystemExit("[ERROR] fwVersion missing in hsm_mapping.json")

    if not os.path.exists(VERSION_MAP_FILE):
        raise SystemExit("[ERROR] version_map.json not found")

    with open(VERSION_MAP_FILE, "r") as f:
        version_map = json.load(f)

    api_version = version_map.get(fw)

    if not api_version:
        raise SystemExit(f"[ERROR] No API version mapping for firmware {fw}")

    print(f"[INFO] Firmware {fw} -> API version {api_version}")
    return api_version


def generate_password(length=16):
    chars = string.ascii_letters + string.digits + "._-"
    return ''.join(secrets.choice(chars) for _ in range(length))


def save_password(username, password):
    data = {}
    if os.path.exists(PW_STORE):
        try:
            with open(PW_STORE, "r") as f:
                data = json.load(f)
        except:
            pass

    data[username] = {
        "password": password,
        "created_at": datetime.datetime.utcnow().isoformat() + "Z"
    }

    with open(PW_STORE, "w") as f:
        json.dump(data, f, indent=2)


# ================= CURL EXEC =================

def run_curl(cmd):
    print("\n[CURL COMMAND]")
    print(" ".join(cmd))
    result = subprocess.run(cmd, capture_output=True, text=True)
    print(result.stdout)
    print(result.stderr)
    return result.stdout + result.stderr


def login_and_get_session(base_url, user, password, version):
    cmd = [
        "curl", "-k", "-i", "-X", "POST",
        "-H", f"Content-Type: application/vnd.safenetinc.lunasa+json;version={version}",
        "-u", f"{user}:{password}",
        f"{base_url}/auth/session"
    ]

    output = run_curl(cmd)

    for line in output.splitlines():
        if "Set-Cookie:" in line and "SESSION_ID" in line:
            session_id = line.split("SESSION_ID=")[1].split(";")[0]
            print("[INFO] SESSION_ID acquired")
            return session_id

    raise SystemExit("[ERROR] Login failed - SESSION_ID not returned")


def create_role(base_url, session_id, version):
    payload = json.dumps({
        "roleId": FIXED_ROLE_NAME,
        "fullName": FIXED_ROLE_NAME
    })

    cmd = [
        "curl", "-k", "-X", "POST",
        "-H", f"Content-Type: application/vnd.safenetinc.lunasa+json;version={version}",
        "-H", f"Cookie: SESSION_ID={session_id}",
        "-d", payload,
        f"{base_url}/roles"
    ]
    run_curl(cmd)


def upload_role_resources(base_url, session_id, version):
    if not os.path.exists(ROLE_RES_FILE):
        raise SystemExit(f"[ERROR] Missing role resource file: {ROLE_RES_FILE}")

    cmd = [
        "curl", "-k", "-X", "PUT",
        "-H", f"Content-Type: application/vnd.safenetinc.lunasa+octet-stream;version={version}",
        "-H", f"Cookie: SESSION_ID={session_id}",
        "--data-binary", f"@{ROLE_RES_FILE}",
        f"{base_url}/roles/{FIXED_ROLE_NAME}/resources"
    ]
    run_curl(cmd)


def create_user(base_url, session_id, version, username, password):
    payload = json.dumps({
        "userId": username,
        "password": password
    })

    cmd = [
        "curl", "-k", "-X", "POST",
        "-H", f"Content-Type: application/vnd.safenetinc.lunasa+json;version={version}",
        "-H", f"Cookie: SESSION_ID={session_id}",
        "-d", payload,
        f"{base_url}/users"
    ]
    run_curl(cmd)


def assign_role(base_url, session_id, version, username):
    payload = json.dumps({"roleId": FIXED_ROLE_NAME})

    cmd = [
        "curl", "-k", "-X", "POST",
        "-H", f"Content-Type: application/vnd.safenetinc.lunasa+json;version={version}",
        "-H", f"Cookie: SESSION_ID={session_id}",
        "-d", payload,
        f"{base_url}/users/{username}/roles"
    ]
    run_curl(cmd)


# ================= MAIN =================

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--hsm-id", required=True)
    parser.add_argument("--env", required=True, choices=["DEV", "TE1", "TE2", "PROD"])
    parser.add_argument("--apiuser", required=True)
    parser.add_argument("--apipass")
    parser.add_argument("--newuser")
    args = parser.parse_args()

    hsm = load_hsm(args.hsm_id)
    base_url = f"https://{hsm.get('ipAddress')}:8443"
    version = map_version_from_fw(hsm)

    user_to_create = args.newuser or ENV_USER_MAP.get(args.env)
    if not user_to_create:
        raise SystemExit("[ERROR] Invalid environment mapping")

    api_password = args.apipass or getpass.getpass(f"Password for {args.apiuser}@HSM: ")

    print(f"[INFO] HSM: {args.hsm_id}")
    print(f"[INFO] Creating user: {user_to_create}")

    session_id = login_and_get_session(base_url, args.apiuser, api_password, version)

    create_role(base_url, session_id, version)
    upload_role_resources(base_url, session_id, version)

    new_password = generate_password()
    create_user(base_url, session_id, version, user_to_create, new_password)
    assign_role(base_url, session_id, version, user_to_create)

    save_password(user_to_create, new_password)

    print(f"\n[SUCCESS] User {user_to_create} created and role applied successfully.")


if __name__ == "__main__":
    main()

#!/usr/bin/env python3

import os
import sys
import json
import subprocess
import shutil

# ================= DEPENDENCY CHECK =================

def check_dependency(cmd):
    if shutil.which(cmd) is None:
        print(f"[ERROR] Required dependency '{cmd}' not found.")
        sys.exit(1)

check_dependency("curl")

# ================= PATHS =================

BASE_DIR = os.getcwd()
RES_DIR = os.path.join(BASE_DIR, "resources")
COOKIE_FILE = os.path.join(BASE_DIR, "cookie.txt")
ROLE_RESOURCE_FILE = os.path.join(RES_DIR, "usermg_role_resources")

HSM_FILE = os.path.join(RES_DIR, "hsm_mapping.json")
VERSION_MAP_FILE = os.path.join(RES_DIR, "version_map.json")

FIXED_ROLE = "usermanagementrole"

# ================= UTIL =================

def load_hsm(hsm_id):
    with open(HSM_FILE) as f:
        data = json.load(f)

    for h in data["hsms"]:
        if h["id"] == hsm_id:
            return h
    print("[ERROR] Invalid HSM ID")
    sys.exit(1)


def map_version(fw):
    with open(VERSION_MAP_FILE) as f:
        version_map = json.load(f)

    api_version = version_map.get(fw, "10")
    print(f"[INFO] Firmware {fw} mapped to API version {api_version}")
    return api_version


def run(cmd):
    print("[DEBUG]", cmd)
    result = subprocess.run(cmd, shell=True)
    if result.returncode != 0:
        print("[ERROR] Command failed")
        sys.exit(1)


# ================= CURL FLOW (MIRRORED) =================

def create_session(ip, apiuser, apipass):
    cmd = (
        f'curl -k -c "{COOKIE_FILE}" '
        f'-u {apiuser}:{apipass} '
        f'https://{ip}:8443/auth/session'
    )
    run(cmd)


def create_role(ip, version):
    cmd = (
        f'curl -k -b "{COOKIE_FILE}" -X POST '
        f'-H "Content-Type: application/vnd.safenetinc.lunasa+json;version={version}" '
        f'-d \'{{"roleId":"{FIXED_ROLE}","fullName":"{FIXED_ROLE}"}}\' '
        f'https://{ip}:8443/roles'
    )
    run(cmd)


def upload_role_resources(ip, version):
    if not os.path.exists(ROLE_RESOURCE_FILE):
        print("[ERROR] Role resource file missing:", ROLE_RESOURCE_FILE)
        sys.exit(1)

    cmd = (
        f'curl -k -b "{COOKIE_FILE}" -X PUT '
        f'-H "Content-Type: application/vnd.safenetinc.lunasa+octet-stream;version={version}" '
        f'--data-binary "@{ROLE_RESOURCE_FILE}" '
        f'https://{ip}:8443/roles/{FIXED_ROLE}/resources'
    )
    run(cmd)


# ================= MAIN =================

def main():
    if len(sys.argv) < 4:
        print("Usage:")
        print("python um_rest_api.py <hsm_id> <apiuser> <apipass>")
        sys.exit(1)

    hsm_id = sys.argv[1]
    apiuser = sys.argv[2]
    apipass = sys.argv[3]

    hsm = load_hsm(hsm_id)
    ip = hsm["ipAddress"]
    fw = hsm["fwVersion"]

    version = map_version(fw)

    print("[INFO] Starting Luna flow via CURL inside Python...")

    create_session(ip, apiuser, apipass)
    create_role(ip, version)
    upload_role_resources(ip, version)

    print("[SUCCESS] Flow completed exactly like working curl")


if __name__ == "__main__":
    main()

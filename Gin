#!/usr/bin/env python3

import sys
import subprocess

def ensure_package(pkg):
    try:
        __import__(pkg)
    except ImportError:
        subprocess.check_call([sys.executable, "-m", "pip", "install", pkg])

for package in ["requests", "urllib3"]:
    ensure_package(package)

import requests
import json
import urllib3
import os
import argparse
import datetime
import secrets
import string
import getpass
import re

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

ROLE_ID = "usermanagementrole"

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
RES_DIR = os.path.join(BASE_DIR, "resources")

HSM_MAP_FILE = os.path.join(RES_DIR, "hsm_mapping.json")
VERSION_MAP_FILE = os.path.join(RES_DIR, "version_map.json")
RESOURCE_FILE = os.path.join(RES_DIR, "usermanagement.txt")
PW_STORE = os.path.join(RES_DIR, "user_passwords.json")

os.makedirs(RES_DIR, exist_ok=True)

def gen_pw(n=16):
    chars = string.ascii_letters + string.digits + "._-"
    return ''.join(secrets.choice(chars) for _ in range(n))

def save_pw(user, pw):
    data = {}
    if os.path.exists(PW_STORE):
        try:
            with open(PW_STORE, "r") as f:
                data = json.load(f)
        except:
            pass

    data[user] = {
        "password": pw,
        "created_at": datetime.datetime.now(datetime.timezone.utc).isoformat()
    }

    with open(PW_STORE, "w") as f:
        json.dump(data, f, indent=2)

def infer_env_from_id(hsm_id):
    lid = hsm_id.lower()
    if "dev" in lid:
        return "DEV"
    if "eng" in lid:
        return "ENG"
    if "prod" in lid:
        return "PROD"
    return None

def load_json(path):
    if not os.path.exists(path):
        raise SystemExit(f"Missing required file: {path}")
    with open(path, "r") as f:
        return json.load(f)

# ---------------- CLI ----------------

parser = argparse.ArgumentParser()
parser.add_argument("--hsm-id", required=True)
parser.add_argument("--env")
parser.add_argument("--apiuser")
parser.add_argument("--apipass")
args = parser.parse_args()

# ---------------- Load Mapping ----------------

hsm_data = load_json(HSM_MAP_FILE)
version_map = load_json(VERSION_MAP_FILE)

hsm_entry = None
for h in hsm_data.get("hsms", []):
    if h.get("id") == args.hsm_id:
        hsm_entry = h
        break

if not hsm_entry:
    raise SystemExit(f"HSM ID not found: {args.hsm_id}")

HSM_IP = hsm_entry.get("ipAddress")
FW_VERSION = hsm_entry.get("fwVersion")
DEFAULT_USER = hsm_entry.get("username")

ENV = args.env or infer_env_from_id(args.hsm_id)

API_VERSION = version_map.get(FW_VERSION)
if not API_VERSION:
    raise SystemExit(f"No API version mapping found for firmware: {FW_VERSION}")

BASE_URL = f"https://{HSM_IP}:8443"

ADMIN_USER = args.apiuser or DEFAULT_USER or "admin"
ADMIN_PASSWORD = args.apipass or getpass.getpass(f"Password for {ADMIN_USER}: ")

HEADERS_JSON = {
    "Content-Type": f"application/vnd.safenetinc.lunasa+json;version={API_VERSION}"
}

HEADERS_STREAM = {
    "Content-Type": f"application/vnd.safenetinc.lunasa+octet-stream;version={API_VERSION}"
}

# ---------------- LOGIN ----------------

login_response = requests.post(
    f"{BASE_URL}/auth/session",
    headers=HEADERS_JSON,
    auth=(ADMIN_USER, ADMIN_PASSWORD),
    verify=False
)

session_id = login_response.cookies.get("SESSION_ID")
if not session_id:
    raise SystemExit("Login failed")

SESSION_HEADERS_JSON = { **HEADERS_JSON, "Cookie": f"SESSION_ID={session_id}" }
SESSION_HEADERS_STREAM = { **HEADERS_STREAM, "Cookie": f"SESSION_ID={session_id}" }

# ---------------- CHECK EXISTING USERS ----------------

users_resp = requests.get(f"{BASE_URL}/users", headers=SESSION_HEADERS_JSON, verify=False)

TARGET_USER = DEFAULT_USER
if TARGET_USER in users_resp.text:
    print(f"User '{TARGET_USER}' already exists. Skipping creation.")
    sys.exit(0)

# ---------------- CREATE ROLE ----------------

requests.post(
    f"{BASE_URL}/roles",
    headers=SESSION_HEADERS_JSON,
    data=json.dumps({"roleId": ROLE_ID, "fullName": ROLE_ID}),
    verify=False
)

# ---------------- UPLOAD RESOURCE ----------------

if not os.path.exists(RESOURCE_FILE):
    raise SystemExit(f"Missing role file: {RESOURCE_FILE}")

with open(RESOURCE_FILE, "rb") as f:
    requests.put(
        f"{BASE_URL}/roles/{ROLE_ID}/resources",
        headers=SESSION_HEADERS_STREAM,
        data=f,
        verify=False
    )

# ---------------- CREATE USER ----------------

USER_PASSWORD = gen_pw()
save_pw(TARGET_USER, USER_PASSWORD)

payload = {
    "userId": TARGET_USER,
    "role": ROLE_ID,
    "password": USER_PASSWORD
}

requests.post(
    f"{BASE_URL}/users",
    headers=SESSION_HEADERS_JSON,
    data=json.dumps(payload),
    verify=False
)

print("Role and user created successfully.")
print(f"User: {TARGET_USER}")

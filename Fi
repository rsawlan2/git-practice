import requests
import sys

BASE_URL = "https://10.24.128.64:8443"

LOGIN_URL = f"{BASE_URL}/auth/session"
ROLES_URL = f"{BASE_URL}/roles"

ROLE_NAME = "customusermanagement"
RESOURCE_FILE = "customusermanagement.txt"

APIUSER = sys.argv[1]
APIPASSWORD = sys.argv[2]

JSON_HEADER = {"Content-Type": "application/vnd.safenetinc.lunasa+json;version=10"}
STREAM_HEADER = {"Content-Type": "application/vnd.safenetinc.lunasa+octet-stream;version=10"}


def get_session_cookie():
    print("1️⃣ LOGIN (curl -u admin:password)")

    r = requests.post(
        LOGIN_URL,
        headers=JSON_HEADER,
        auth=(APIUSER, APIPASSWORD),
        verify=False
    )

    if r.status_code != 204:
        raise Exception(f"Login failed: {r.status_code}")

    if "SESSION_ID" not in r.cookies:
        raise Exception("No SESSION_ID returned")

    session_id = r.cookies["SESSION_ID"]
    print("✅ SESSION_ID received")
    return session_id


def create_role(session_id):
    print("2️⃣ CREATE ROLE")

    payload = {
        "roleId": ROLE_NAME,
        "fullName": ROLE_NAME
    }

    r = requests.post(
        ROLES_URL,
        headers={**JSON_HEADER, "Cookie": f"SESSION_ID={session_id}"},
        json=payload,
        verify=False
    )

    print("Status:", r.status_code)


def upload_resources(session_id):
    print("3️⃣ UPLOAD RESOURCE FILE")

    with open(RESOURCE_FILE, "rb") as f:
        data = f.read()

    r = requests.put(
        f"{ROLES_URL}/{ROLE_NAME}/resources",
        headers={**STREAM_HEADER, "Cookie": f"SESSION_ID={session_id}"},
        data=data,
        verify=False
    )

    print("Status:", r.status_code)


def verify_role(session_id):
    print("4️⃣ VERIFY ROLE")

    r = requests.get(
        ROLES_URL,
        headers={**JSON_HEADER, "Cookie": f"SESSION_ID={session_id}"},
        verify=False
    )

    print(r.text)


if __name__ == "__main__":
    requests.packages.urllib3.disable_warnings()

    sid = get_session_cookie()
    create_role(sid)
    upload_resources(sid)
    verify_role(sid)

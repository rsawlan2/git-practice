import requests
import sys
import base64

BASE_URL = "https://10.24.128.64:8443"
ROLE_NAME = "customusermanagement"
RESOURCE_FILE = "customusermanagement.txt"

APIUSER = sys.argv[1]
APIPASSWORD = sys.argv[2]

LOGIN_URL = f"{BASE_URL}/auth/session"
ROLES_URL = f"{BASE_URL}/roles"

def build_auth_header(user, password):
    token = base64.b64encode(f"{user}:{password}".encode()).decode()
    return f"Basic {token}"


def get_session_cookie():
    print("1️⃣ LOGIN (exact curl behaviour)")

    headers = {
        "Content-Type": "application/vnd.safenetinc.lunasa+json;version=10",
        "Authorization": build_auth_header(APIUSER, APIPASSWORD)
    }

    r = requests.post(
        LOGIN_URL,
        headers=headers,
        verify=False,
        allow_redirects=False
    )

    print("Status:", r.status_code)
    print("Response headers:", r.headers)

    if r.status_code != 204:
        raise Exception(f"Login failed: {r.status_code}")

    cookie_header = r.headers.get("Set-Cookie")
    if not cookie_header or "SESSION_ID" not in cookie_header:
        raise Exception("SESSION_ID not found in Set-Cookie header")

    session_id = cookie_header.split("SESSION_ID=")[1].split(";")[0]
    print("✅ SESSION_ID:", session_id)
    return session_id


def create_role(session_id):
    print("2️⃣ CREATE ROLE")

    payload = {
        "roleId": ROLE_NAME,
        "fullName": ROLE_NAME
    }

    headers = {
        "Content-Type": "application/vnd.safenetinc.lunasa+json;version=10",
        "Cookie": f"SESSION_ID={session_id}"
    }

    r = requests.post(ROLES_URL, headers=headers, json=payload, verify=False)
    print("Status:", r.status_code)


def upload_resources(session_id):
    print("3️⃣ UPLOAD RESOURCES")

    headers = {
        "Content-Type": "application/vnd.safenetinc.lunasa+octet-stream;version=10",
        "Cookie": f"SESSION_ID={session_id}"
    }

    with open(RESOURCE_FILE, "rb") as f:
        r = requests.put(
            f"{ROLES_URL}/{ROLE_NAME}/resources",
            headers=headers,
            data=f,
            verify=False
        )

    print("Status:", r.status_code)


def verify_role(session_id):
    print("4️⃣ VERIFY ROLE")

    headers = {
        "Content-Type": "application/vnd.safenetinc.lunasa+json;version=10",
        "Cookie": f"SESSION_ID={session_id}"
    }

    r = requests.get(ROLES_URL, headers=headers, verify=False)
    print(r.text)


if __name__ == "__main__":
    requests.packages.urllib3.disable_warnings()

    sid = get_session_cookie()
    create_role(sid)
    upload_resources(sid)
    verify_role(sid)

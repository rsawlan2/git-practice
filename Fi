import requests
import sys
import base64

BASE_URL = "https://10.24.128.64:8443"
ROLE_NAME = "customusermanagement"
RESOURCE_FILE = "customusermanagement.txt"

APIUSER = sys.argv[1]
APIPASSWORD = sys.argv[2]

LOGIN_URL = f"{BASE_URL}/auth/session"
ROLES_URL = f"{BASE_URL}/roles"


def basic_auth(user, pwd):
    token = base64.b64encode(f"{user}:{pwd}".encode()).decode()
    return f"Basic {token}"


def get_session_cookie():
    print("üîê LOGIN (curl-style exact replication)")

    headers = {
        "Content-Type": "application/vnd.safenetinc.lunasa+json;version=10",
        "Authorization": basic_auth(APIUSER, APIPASSWORD),
        "Content-Length": "0"
    }

    r = requests.post(
        LOGIN_URL,
        headers=headers,
        data="",              # MUST be empty string
        verify=False
    )

    print("Status:", r.status_code)

    if r.status_code != 204:
        print("Headers:", r.headers)
        print("Body:", r.text)
        raise Exception(f"Login failed: {r.status_code}")

    cookie = r.headers.get("Set-Cookie")
    if not cookie or "SESSION_ID" not in cookie:
        raise Exception("SESSION_ID not returned by server")

    session_id = cookie.split("SESSION_ID=")[1].split(";")[0]
    print("‚úÖ SESSION_ID:", session_id)
    return session_id


def create_role(session_id):
    print("üì¶ Creating role")

    headers = {
        "Content-Type": "application/vnd.safenetinc.lunasa+json;version=10",
        "Cookie": f"SESSION_ID={session_id}"
    }

    payload = {
        "roleId": ROLE_NAME,
        "fullName": ROLE_NAME
    }

    r = requests.post(ROLES_URL, headers=headers, json=payload, verify=False)
    print("Create Role Status:", r.status_code)


def upload_resources(session_id):
    print("üì§ Uploading resources")

    headers = {
        "Content-Type": "application/vnd.safenetinc.lunasa+octet-stream;version=10",
        "Cookie": f"SESSION_ID={session_id}"
    }

    with open(RESOURCE_FILE, "rb") as f:
        r = requests.put(
            f"{ROLES_URL}/{ROLE_NAME}/resources",
            headers=headers,
            data=f,
            verify=False
        )

    print("Upload Status:", r.status_code)


def verify_role(session_id):
    print("üîé Verifying role")

    headers = {
        "Content-Type": "application/vnd.safenetinc.lunasa+json;version=10",
        "Cookie": f"SESSION_ID={session_id}"
    }

    r = requests.get(ROLES_URL, headers=headers, verify=False)
    print(r.text)


if __name__ == "__main__":
    requests.packages.urllib3.disable_warnings()

    sid = get_session_cookie()
    create_role(sid)
    upload_resources(sid)
    verify_role(sid)

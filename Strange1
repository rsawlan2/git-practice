#!/usr/bin/env python3

import sys
import subprocess

def ensure_package(pkg):
    try:
        __import__(pkg)
    except ImportError:
        subprocess.check_call([sys.executable, "-m", "pip", "install", pkg])

for package in ["requests", "urllib3"]:
    ensure_package(package)

import requests
import json
import urllib3
import os
import argparse
import datetime
import secrets
import string
import getpass

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

BASE_URL = "https://10.24.128.64:8443"
ROLE_ID = "usermanagementrole"

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
RES_DIR = os.path.join(BASE_DIR, "resources")

RESOURCE_FILE = os.path.join(RES_DIR, "usermanagement.txt")
PW_STORE = os.path.join(RES_DIR, "user_passwords.json")

os.makedirs(RES_DIR, exist_ok=True)

ENV_USER_MAP = {
    "DEV": "svc_at48994_usrmgt",
    "TE1": "svc_at48993_usrmgt",
    "TE2": "svc_at48992_usrmgt",
    "PROD": "svc_at49008_usrmgt"
}

def gen_pw(n=16):
    chars = string.ascii_letters + string.digits + "._-"
    return ''.join(secrets.choice(chars) for _ in range(n))

def save_pw(user, pw):
    data = {}
    if os.path.exists(PW_STORE):
        try:
            with open(PW_STORE, "r") as f:
                data = json.load(f)
        except:
            pass

    data[user] = {
        "password": pw,
        "created_at": datetime.datetime.now(datetime.timezone.utc).isoformat()
    }

    with open(PW_STORE, "w") as f:
        json.dump(data, f, indent=2)

# ---------------- CLI ----------------

parser = argparse.ArgumentParser()
parser.add_argument("--env", required=True, choices=["DEV", "TE1", "TE2", "PROD"])
parser.add_argument("--apiuser", default="admin")
parser.add_argument("--apipass")
args = parser.parse_args()

ADMIN_USER = args.apiuser
ADMIN_PASSWORD = args.apipass or getpass.getpass(f"Password for {ADMIN_USER}: ")

USER_ID = ENV_USER_MAP.get(args.env)
if not USER_ID:
    raise SystemExit("Invalid environment")

HEADERS_JSON = {
    "Content-Type": "application/vnd.safenetinc.lunasa+json;version=10"
}

# ---------------- LOGIN ----------------

login_response = requests.post(
    f"{BASE_URL}/auth/session",
    headers=HEADERS_JSON,
    auth=(ADMIN_USER, ADMIN_PASSWORD),
    verify=False
)

session_id = login_response.cookies.get("SESSION_ID")
if not session_id:
    raise SystemExit("Login failed")

SESSION_HEADERS_JSON = {
    **HEADERS_JSON,
    "Cookie": f"SESSION_ID={session_id}"
}

SESSION_HEADERS_STREAM = {
    "Content-Type": "application/vnd.safenetinc.lunasa+octet-stream;version=10",
    "Cookie": f"SESSION_ID={session_id}"
}

# ---------------- CHECK IF USER EXISTS ----------------

existing_users = requests.get(
    f"{BASE_URL}/users",
    headers=SESSION_HEADERS_JSON,
    verify=False
)

if USER_ID in existing_users.text:
    print(f"User '{USER_ID}' already exists. Skipping creation.")
    sys.exit(0)

# ---------------- PASSWORD GENERATION ----------------

USER_PASSWORD = gen_pw()
save_pw(USER_ID, USER_PASSWORD)

# ---------------- ROLE CREATION ----------------

requests.post(
    f"{BASE_URL}/roles",
    headers=SESSION_HEADERS_JSON,
    data=json.dumps({"roleId": ROLE_ID, "fullName": ROLE_ID}),
    verify=False
)

roles_check = requests.get(
    f"{BASE_URL}/roles",
    headers=SESSION_HEADERS_JSON,
    verify=False
)

if ROLE_ID not in roles_check.text:
    raise SystemExit("Role creation failed")

# ---------------- RESOURCE UPLOAD ----------------

if not os.path.exists(RESOURCE_FILE):
    raise SystemExit(f"Missing role file: {RESOURCE_FILE}")

with open(RESOURCE_FILE, "rb") as f:
    requests.put(
        f"{BASE_URL}/roles/{ROLE_ID}/resources",
        headers=SESSION_HEADERS_STREAM,
        data=f,
        verify=False
    )

# ---------------- USER CREATION ----------------

user_payload = {
    "userId": USER_ID,
    "role": ROLE_ID,
    "password": USER_PASSWORD
}

requests.post(
    f"{BASE_URL}/users",
    headers=SESSION_HEADERS_JSON,
    data=json.dumps(user_payload),
    verify=False
)

print("Role and user created successfully.")
print(f"User: {USER_ID}")

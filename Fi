#!/usr/bin/env python3
import os
import sys
import json
import subprocess
import argparse
import shutil
import getpass

RES_DIR = "resources"
HSM_FILE = os.path.join(RES_DIR, "hsm_mapping.json")
ROLE_RES_FILE = os.path.join(RES_DIR, "usermg_role_resources")
COOKIE_FILE = os.path.join(RES_DIR, "luna_session.cookie")

FIXED_ROLE_NAME = "usermanagementrole"


# ----------------- Dependency check -----------------
def require(cmd):
    if not shutil.which(cmd):
        print(f"[ERROR] Required dependency '{cmd}' not found")
        sys.exit(1)

require("curl")


# ----------------- Load HSM -----------------
def load_hsm(hsm_id):
    with open(HSM_FILE, "r") as f:
        data = json.load(f)

    for h in data.get("hsms", []):
        if h.get("id") == hsm_id:
            return h

    print("[ERROR] Invalid HSM ID")
    sys.exit(1)


# ----------------- Version mapping -----------------
def map_version(fw):
    if fw.startswith("7.3"):
        return "7"
    if fw.startswith("7.7"):
        return "10"
    return "10"


# ----------------- Execute curl -----------------
def run(cmd):
    print("[CURL]", " ".join(cmd))
    return subprocess.call(cmd)


# ----------------- Main Flow -----------------
def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--hsm-id", required=True)
    parser.add_argument("--env", required=True)
    parser.add_argument("--apiuser", required=True)
    parser.add_argument("--apipass")
    parser.add_argument("--newuser", required=True)

    args = parser.parse_args()

    hsm = load_hsm(args.hsm_id)
    host = hsm["ipAddress"]
    version = map_version(hsm["fwVersion"])

    base = f"https://{host}:8443"

    api_pass = args.apipass or getpass.getpass("API Password: ")

    print(f"[INFO] Target HSM: {args.hsm_id}")
    print(f"[INFO] Firmware: {hsm['fwVersion']} -> API version {version}")
    print(f"[INFO] New user: {args.newuser}")

    # 1. LOGIN (exact curl behaviour)
    run([
        "curl", "-k", "-ss",
        "-c", COOKIE_FILE,
        "-u", f"{args.apiuser}:{api_pass}",
        "-H", f"Content-Type: application/vnd.safenetinc.lunasa+json;version={version}",
        f"{base}/auth/session"
    ])

    if not os.path.exists(COOKIE_FILE):
        print("[ERROR] Login failed - SESSION_ID cookie not created")
        sys.exit(1)

    # 2. CREATE ROLE
    run([
        "curl", "-k", "-b", COOKIE_FILE, "-X", "POST",
        "-H", f"Content-Type: application/vnd.safenetinc.lunasa+json;version={version}",
        "-d", f'{{"roleId":"{FIXED_ROLE_NAME}","fullName":"{FIXED_ROLE_NAME}"}}',
        f"{base}/roles"
    ])

    # 3. UPLOAD ROLE RESOURCES
    if not os.path.exists(ROLE_RES_FILE):
        print(f"[ERROR] Missing role resource file: {ROLE_RES_FILE}")
        sys.exit(1)

    run([
        "curl", "-k", "-b", COOKIE_FILE, "-X", "PUT",
        "-H", f"Content-Type: application/vnd.safenetinc.lunasa+octet-stream;version={version}",
        "--data-binary", f"@{ROLE_RES_FILE}",
        f"{base}/roles/{FIXED_ROLE_NAME}/resources"
    ])

    # 4. CREATE USER
    run([
        "curl", "-k", "-b", COOKIE_FILE, "-X", "POST",
        "-H", f"Content-Type: application/vnd.safenetinc.lunasa+json;version={version}",
        "-d", f'{{"userId":"{args.newuser}","password":"TempPass@123"}}',
        f"{base}/api/lunasa/users"
    ])

    # 5. ASSIGN ROLE TO USER
    run([
        "curl", "-k", "-b", COOKIE_FILE, "-X", "POST",
        "-H", f"Content-Type: application/vnd.safenetinc.lunasa+json;version={version}",
        "-d", f'{{"roleId":"{FIXED_ROLE_NAME}"}}',
        f"{base}/api/lunasa/users/{args.newuser}/roles"
    ])

    print("âœ… FULL FLOW EXECUTED SUCCESSFULLY (curl-mirrored)")


if __name__ == "__main__":
    main()

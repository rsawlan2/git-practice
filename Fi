#!/usr/bin/env python3

try:
    import requests
except ImportError:
    import subprocess, sys
    subprocess.check_call([sys.executable, "-m", "pip", "install", "requests"])
    import requests

import argparse
import os
import json
import datetime
import secrets
import string
import getpass
import re

RES_DIR = "resources"
HSM_FILE = os.path.join(RES_DIR, "hsm_mapping.json")
PW_STORE = os.path.join(RES_DIR, "user_passwords.json")
ROLE_RES_FILE = os.path.join(RES_DIR, "usermg_role_resources")
os.makedirs(RES_DIR, exist_ok=True)

FIXED_ROLE_NAME = "usermanagementrole"

ENV_USER_MAP = {
    "DEV": "svc_at48994_usrmgt",
    "TE1": "svc_at48993_usrmgt",
    "TE2": "svc_at48992_usrmgt",
    "PROD": "svc_at49008_usrmgt"
}


def load_hsm(hsm_id):
    if not os.path.exists(HSM_FILE):
        raise SystemExit(f"[ERROR] missing: {HSM_FILE}")
    with open(HSM_FILE, "r") as f:
        data = json.load(f)
    for h in data.get("hsms", []):
        if h.get("id") == hsm_id:
            return h
    raise SystemExit(f"[ERROR] HSM '{hsm_id}' not found")


def gen_pw(n=16):
    chars = string.ascii_letters + string.digits + "._-"
    return ''.join(secrets.choice(chars) for _ in range(n))


def save_pw(user, pw):
    data = {}
    if os.path.exists(PW_STORE):
        try:
            with open(PW_STORE, "r") as f:
                data = json.load(f)
        except:
            data = {}
    data[user] = {"password": pw, "created_at": datetime.datetime.utcnow().isoformat() + "Z"}
    tmp = PW_STORE + ".tmp"
    with open(tmp, "w") as f:
        json.dump(data, f, indent=2)
    os.replace(tmp, PW_STORE)


def detect_version(base_url, session):
    r = session.get(base_url + "/", verify=False)
    ct = r.headers.get("Content-Type", "")
    m = re.search(r"version=(\d+)", ct)
    return m.group(1) if m else "10"


def create_session(base_url, session, user, password, version):
    headers = {
        "Content-Type": f"application/vnd.safenetinc.lunasa+json;version={version}"
    }
    r = session.post(
        base_url + "/auth/session",
        headers=headers,
        auth=(user, password),
        verify=False
    )
    return r.status_code == 204


def create_role(base_url, session, version):
    headers = {
        "Content-Type": f"application/vnd.safenetinc.lunasa+json;version={version}"
    }
    payload = {
        "roleId": FIXED_ROLE_NAME,
        "fullName": FIXED_ROLE_NAME
    }
    session.post(base_url + "/roles", headers=headers, json=payload, verify=False)


def upload_role_resources(base_url, session, version):
    if not os.path.exists(ROLE_RES_FILE):
        raise SystemExit(f"[ERROR] missing role resource file: {ROLE_RES_FILE}")

    with open(ROLE_RES_FILE, "rb") as f:
        raw = f.read()

    headers = {
        "Content-Type": f"application/vnd.safenetinc.lunasa+octet-stream;version={version}"
    }

    session.put(
        f"{base_url}/roles/{FIXED_ROLE_NAME}/resources",
        headers=headers,
        data=raw,
        verify=False
    )


def create_user(base_url, session, version, username):
    headers = {
        "Content-Type": f"application/vnd.safenetinc.lunasa+json;version={version}"
    }
    pw = gen_pw()
    payload = {
        "userId": username,
        "password": pw
    }
    r = session.post(base_url + "/api/lunasa/users", headers=headers, json=payload, verify=False)
    if r.status_code not in (200, 201, 204):
        return None
    save_pw(username, pw)
    return pw


def assign_role(base_url, session, version, username):
    headers = {
        "Content-Type": f"application/vnd.safenetinc.lunasa+json;version={version}"
    }
    payload = {"roleId": FIXED_ROLE_NAME}
    session.post(
        f"{base_url}/api/lunasa/users/{username}/roles",
        headers=headers,
        json=payload,
        verify=False
    )


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--hsm-id", required=True)
    parser.add_argument("--env", required=True, choices=["DEV", "TE1", "TE2", "PROD"], type=str.upper)
    parser.add_argument("--sshuser", default="admin")
    parser.add_argument("--sshpassword")
    parser.add_argument("--newuser")
    args = parser.parse_args()

    env = args.env
    new_user = args.newuser or ENV_USER_MAP.get(env)
    if not new_user:
        raise SystemExit("[ERROR] invalid env")

    print(f"[INFO] env {env}: user {new_user}")

    admin_user = args.sshuser
    admin_pw = args.sshpassword or getpass.getpass(f"Password for {admin_user}@HSM: ")

    h = load_hsm(args.hsm_id)
    host = h.get("ipAddress") or h.get("host")
    base_url = f"https://{host}:8443"

    session = requests.Session()

    version = detect_version(base_url, session)

    if not create_session(base_url, session, admin_user, admin_pw, version):
        print("[ERROR] failed to establish session")
        return

    create_role(base_url, session, version)
    upload_role_resources(base_url, session, version)

    pw = create_user(base_url, session, version, new_user)
    if not pw:
        print("[ERROR] user creation failed")
        return

    assign_role(base_url, session, version, new_user)

    print(f"[INFO] complete for HSM {args.hsm_id} ({env})")


if __name__ == "__main__":
    main()

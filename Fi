#!/usr/bin/env python3
"""
Luna HSM User Management (REST)
-------------------------------
Creates a user on the HSM, uploads a role resource file, and assigns it.
Uses HSM mapping from resources/hsm_mapping.json and env-based user selection.
Strict mirror of the original Luna shell script behaviour.
"""

try:
    import requests
except ImportError:
    import subprocess, sys
    print("[INFO] installing requests...")
    subprocess.check_call([sys.executable, "-m", "pip", "install", "requests"])
    import requests

import argparse
import os
import json
import datetime
import secrets
import string
import getpass

# paths
RES_DIR = "resources"
HSM_FILE = os.path.join(RES_DIR, "hsm_mapping.json")
PW_STORE = os.path.join(RES_DIR, "user_passwords.json")
ROLE_RES_FILE = os.path.join(RES_DIR, "usermg_role_resources")
os.makedirs(RES_DIR, exist_ok=True)

FIXED_ROLE_NAME = "usermanagementrole"

ENV_USER_MAP = {
    "DEV": "svc_at48994_usrmgt",
    "TE1": "svc_at48993_usrmgt",
    "TE2": "svc_at48992_usrmgt",
    "PROD": "svc_at49008_usrmgt"
}


def load_hsm(hsm_id):
    if not os.path.exists(HSM_FILE):
        raise SystemExit(f"[ERROR] missing: {HSM_FILE}")
    with open(HSM_FILE, "r") as f:
        data = json.load(f)
    for h in data.get("hsms", []):
        if h.get("id") == hsm_id:
            return h
    raise SystemExit(f"[ERROR] HSM '{hsm_id}' not found")


def gen_pw(n=16):
    chars = string.ascii_letters + string.digits + "._-"
    return ''.join(secrets.choice(chars) for _ in range(n))


def save_pw(user, pw):
    data = {}
    if os.path.exists(PW_STORE):
        try:
            with open(PW_STORE, "r") as f:
                data = json.load(f)
        except:
            data = {}

    data[user] = {
        "password": pw,
        "created_at": datetime.datetime.utcnow().isoformat() + "Z"
    }

    tmp = PW_STORE + ".tmp"
    with open(tmp, "w") as f:
        json.dump(data, f, indent=2)
    os.replace(tmp, PW_STORE)

    try:
        os.chmod(PW_STORE, 0o600)
    except:
        pass


def create_session(base_url, username, password):
    print("[INFO] creating session...")
    s = requests.Session()
    s.auth = (username, password)

    r = s.post(f"{base_url}/auth/session", timeout=15)
    if r.status_code not in (200, 201, 204):
        raise SystemExit(f"[ERROR] failed to establish session (status {r.status_code})")

    return s


def ensure_role_exists(session, base_url):
    r = session.get(f"{base_url}/roles", timeout=15)
    if FIXED_ROLE_NAME.lower() in r.text.lower():
        return True

    payload = {
        "roleId": FIXED_ROLE_NAME,
        "fullName": FIXED_ROLE_NAME
    }
    r = session.post(f"{base_url}/roles", json=payload, timeout=20)

    return r.status_code in (200, 201, 204)


def upload_role_resources(session, base_url):
    if not os.path.exists(ROLE_RES_FILE):
        raise SystemExit(f"[ERROR] missing role resource file: {ROLE_RES_FILE}")

    print(f"[INFO] uploading role resource file '{ROLE_RES_FILE}'...")

    with open(ROLE_RES_FILE, "rb") as f:
        headers = {
            "Content-Type": "application/vnd.safenetinc.lunasa+octet-stream;version=10"
        }
        r = session.put(
            f"{base_url}/roles/{FIXED_ROLE_NAME}/resources",
            headers=headers,
            data=f.read(),
            timeout=60
        )

    if r.status_code not in (200, 201, 204):
        print(f"[ERROR] role resource upload failed (status {r.status_code})")
        return False

    print("[INFO] role resources applied")
    return True


def create_user(session, base_url, username, password):
    payload = {
        "username": username,
        "password": password
    }

    r = session.post(f"{base_url}/users", json=payload, timeout=30)

    if r.status_code not in (200, 201, 204):
        print(f"[ERROR] user creation failed for '{username}'")
        return False

    save_pw(username, password)
    print(f"[INFO] user '{username}' created")
    return True


def assign_role(session, base_url, username):
    payload = {
        "username": username,
        "roleId": FIXED_ROLE_NAME
    }

    r = session.post(f"{base_url}/users/{username}/roles", json=payload, timeout=30)

    if r.status_code not in (200, 201, 204):
        print(f"[ERROR] couldn't assign role to '{username}'")
        return False

    print(f"[INFO] role assigned to '{username}'")
    return True


def hsm_health_check(session, base_url):
    r = session.get(f"{base_url}/api/lunasa", timeout=10)
    if r.status_code == 200:
        print("[INFO] HSM reachable")


def main():
    parser = argparse.ArgumentParser(description="Luna HSM User Management (REST)")
    parser.add_argument("--hsm-id", required=True)
    parser.add_argument("--env", required=True, choices=["DEV","TE1","TE2","PROD"], type=str.upper)
    parser.add_argument("--apiuser", default="admin")
    parser.add_argument("--apipassword")
    parser.add_argument("--newuser")
    args = parser.parse_args()

    if args.newuser:
        new_user = args.newuser
        print(f"[INFO] using provided user: {new_user}")
    else:
        new_user = ENV_USER_MAP.get(args.env)
        if not new_user:
            raise SystemExit(f"[ERROR] invalid env '{args.env}'")
        print(f"[INFO] env {args.env}: user {new_user}")

    api_pw = args.apipassword or getpass.getpass(f"Password for {args.apiuser}@HSM: ")

    h = load_hsm(args.hsm_id)
    host = h.get("ipAddress") or h.get("host")
    base_url = f"https://{host}"

    session = create_session(base_url, args.apiuser, api_pw)

    if not ensure_role_exists(session, base_url):
        raise SystemExit("[ERROR] could not create/find role")

    if not upload_role_resources(session, base_url):
        return

    user_pw = gen_pw()
    if not create_user(session, base_url, new_user, user_pw):
        return

    if not assign_role(session, base_url, new_user):
        return

    hsm_health_check(session, base_url)
    print(f"[INFO] complete for HSM {args.hsm_id} ({args.env})")


if __name__ == "__main__":
    main()
